<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- SEO Primary Meta Tags -->
  <title>Calculadora de Impuestos Crypto Espa√±a 2026 - IRPF Bitcoin | Tramos Actualizados</title>
  <meta name="title" content="Calculadora de Impuestos Crypto Espa√±a 2026 - IRPF Bitcoin | Tramos Actualizados">
  <meta name="description" content="Calcula cu√°nto pagar√°s a Hacienda por tus ganancias en Bitcoin y criptomonedas. Tramos IRPF 2025 actualizados, m√©todo FIFO, compensaci√≥n de p√©rdidas. Gratis.">
  <meta name="keywords" content="impuestos criptomonedas espa√±a, calculadora irpf bitcoin, impuestos bitcoin espa√±a 2026, hacienda criptomonedas, ganancia patrimonial crypto, FIFO bitcoin">
  <meta name="author" content="Bitcoin Calculadora">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://bitcoincalculadora.com/calculadora-impuestos/">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://bitcoincalculadora.com/calculadora-impuestos/">
  <meta property="og:title" content="Calculadora de Impuestos Crypto Espa√±a 2026 - ¬øCu√°nto pagas a Hacienda?}}">
  <meta property="og:description" content="Calcula tu carga fiscal por Bitcoin y criptomonedas en Espa√±a. Tramos IRPF actualizados a 2025.}}">
  <meta property="og:image" content="https://bitcoincalculadora.com/assets/og-image.png">
  <meta property="og:locale" content="es_ES">
  <meta property="og:site_name" content="Bitcoin Calculadora">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://bitcoincalculadora.com/calculadora-impuestos/">
  <meta name="twitter:title" content="Calculadora de Impuestos Crypto Espa√±a 2026 - ¬øCu√°nto pagas a Hacienda?}}">
  <meta name="twitter:description" content="Calcula tu carga fiscal por Bitcoin y criptomonedas en Espa√±a. Tramos IRPF actualizados a 2025.}}">
  <meta name="twitter:image" content="https://bitcoincalculadora.com/assets/og-image.png">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Calculadora de Impuestos Crypto Espa√±a",
    "description": "Calcula el IRPF sobre ganancias patrimoniales de criptomonedas en Espa√±a",
    "url": "https://bitcoincalculadora.com/calculadora-impuestos/",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "EUR" }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "¬øCu√°nto pago de impuestos por vender Bitcoin en Espa√±a?",
        "acceptedAnswer": { "@type": "Answer", "text": "Las ganancias por venta de Bitcoin tributan en la base del ahorro del IRPF con tipos progresivos: 19% hasta 6.000‚Ç¨, 21% hasta 50.000‚Ç¨, 23% hasta 200.000‚Ç¨, 27% hasta 300.000‚Ç¨ y 30% a partir de 300.000‚Ç¨ (tramos vigentes desde enero 2025)." }
      },
      {
        "@type": "Question",
        "name": "¬øQu√© m√©todo se usa para calcular la ganancia en crypto en Espa√±a?",
        "acceptedAnswer": { "@type": "Answer", "text": "En Espa√±a se aplica el m√©todo FIFO (First In, First Out). Esto significa que cuando vendes, el coste de adquisici√≥n se calcula usando el precio de la primera compra que hiciste, no la √∫ltima." }
      },
      {
        "@type": "Question",
        "name": "¬øPuedo compensar p√©rdidas en criptomonedas?",
        "acceptedAnswer": { "@type": "Answer", "text": "S√≠. Puedes compensar p√©rdidas con ganancias patrimoniales del mismo a√±o. Si quedan p√©rdidas pendientes, puedes compensar hasta un 25% de los rendimientos del capital mobiliario, y arrastrar las p√©rdidas no compensadas durante los 4 ejercicios fiscales siguientes." }
      }
    ]
  }
  </script>
  

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23f7931a'/><text y='.9em' x='50%' text-anchor='middle' font-size='70' fill='white'>‚Çø</text></svg>">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="/css/styles.css">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZSPP1PNLP1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZSPP1PNLP1');
  </script>


  <style>
.legal-notice { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 32px; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.6; }
    .legal-notice strong { color: var(--accent); }
    .tramos-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 0.875rem; }
    .tramos-table th { text-align: left; padding: 10px 12px; background: var(--surface); color: var(--accent); border-bottom: 1px solid var(--border); font-weight: 500; }
    .tramos-table td { padding: 10px 12px; border-bottom: 1px solid rgba(131,128,128,0.3); }
    .tramos-table tr:last-child td { border-bottom: none; }
    .tramos-table .highlight-row { background: var(--accent-dim); }
    .tax-section { margin-bottom: 32px; }
    .tax-section h3 { font-size: 1rem; font-weight: 500; margin-bottom: 12px; }
    .operations-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; }
    .operation-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .operation-row .input-label { margin-bottom: 4px; }
    .add-btn, .calc-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.9375rem; transition: opacity 0.2s; }
    .add-btn { background: var(--surface); border: 1px dashed var(--border); color: var(--text-secondary); margin-bottom: 16px; }
    .add-btn:hover { border-color: var(--accent); color: var(--accent); }
    .calc-btn { background: var(--accent); color: #000; }
    .calc-btn:hover { opacity: 0.9; }
    .remove-op { background: none; border: none; color: var(--red); cursor: pointer; font-size: 0.8125rem; padding: 4px 8px; float: right; }
    .breakdown-item { display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.875rem; border-bottom: 1px solid rgba(131,128,128,0.2); }
    .breakdown-item:last-child { border-bottom: none; }
    .total-tax { font-size: 1.25rem; font-weight: 600; color: var(--accent); }
    .info-box { background: var(--green-dim); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 12px; font-size: 0.8125rem; color: var(--text-secondary); margin: 12px 0; }
    .switch-mode { display: flex; gap: 0; margin-bottom: 24px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
    .switch-mode button { flex: 1; padding: 10px; background: var(--surface); border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
    .switch-mode button.active { background: var(--accent); color: #000; font-weight: 600; }
    .error-msg { color: var(--red); font-size: 0.875rem; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px; display: none; }
    .positive { color: var(--green) !important; }
    .negative { color: var(--red) !important; }
    .loss-info { font-size: 0.8125rem; color: var(--text-secondary); margin-top: 8px; }
  </style>

</head>
<body>

  <div class="site-nav">
    <div class="nav-inner">
      <div class="nav-top">
        <a href="/" class="nav-brand">
          <svg class="btc-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#f7931a"/><path d="M67.8 44.3c1-6.6-4-10.2-10.9-12.5l2.2-8.9-5.4-1.3-2.2 8.7c-1.4-.4-2.9-.7-4.3-1l2.2-8.7-5.4-1.3-2.2 8.9c-1.2-.3-2.3-.5-3.4-.8l-7.5-1.9-1.4 5.8s4 .9 3.9 1c2.2.5 2.6 2 2.5 3.1l-2.5 10.2c.2 0 .3.1.5.1l-.5-.1-3.6 14.3c-.3.7-.9 1.7-2.5 1.3.1.1-3.9-1-3.9-1L22 66l7 1.7c1.3.3 2.6.7 3.9 1l-2.3 9 5.4 1.3 2.2-8.9c1.5.4 2.9.8 4.3 1.1l-2.2 8.8 5.4 1.3 2.3-9c9.3 1.8 16.3.7 19.3-7.4 2.4-6.5-.1-10.3-4.8-12.7 3.4-.8 6-3.1 6.7-7.9zM58 55c-1.7 6.8-13.2 3.1-16.9 2.2l3-12.1c3.7.9 15.7 2.8 13.9 9.9zm1.7-17.5c-1.6 6.2-11.1 3-14.2 2.3l2.7-11c3.1.8 13.2 2.2 11.5 8.7z" fill="#fff"/></svg>
          <span>Bitcoin Calculadora</span>
          <span class="nav-subtitle">Calculadora de impuestos crypto</span>
        </a>
        <button class="nav-hamburger" onclick="document.querySelector('.nav-calculadoras').classList.toggle('open');this.textContent=this.textContent==='‚ò∞'?'‚úï':'‚ò∞'" aria-label="Men√∫">‚ò∞</button>
      </div>
    <!-- Navegaci√≥n entre calculadoras -->
    <nav class="nav-calculadoras" aria-label="Calculadoras disponibles">
      <a href="/" class="nav-link ">üí∞ Sueldo</a>
      <a href="/calculadora-dca/" class="nav-link ">üìà DCA</a>
      <a href="/conversor/" class="nav-link ">üîÑ Conversor</a>
      <a href="/si-hubiera-comprado/" class="nav-link ">üï∞Ô∏è Si hubiera...</a>
      <a href="/calculadora-impuestos/" class="nav-link active">üßæ Impuestos</a>
      <a href="/calculadora-fees/" class="nav-link ">‚õèÔ∏è Fees</a>
      <a href="/comparador-exchanges/" class="nav-link ">üè¶ Exchanges</a>
      <a href="/calculadora-herencia/" class="nav-link ">üìú Herencia</a>
      <a href="/blog/" class="nav-link ">üìù Blog</a>
    </nav>

    </div>
  </div>

  <main class="container">

<div class="hero-text">
      <h2>Calculadora de <span class="accent">impuestos crypto</span> Espa√±a</h2>
      <p>Estima cu√°nto pagar√°s a Hacienda por tus ganancias en Bitcoin y criptomonedas.</p>
    </div>

    <!-- Legal notice -->
    <div class="legal-notice">
      <strong>‚ö†Ô∏è Aviso legal:</strong> Esta calculadora es orientativa y no sustituye el asesoramiento de un profesional fiscal. Los tramos mostrados corresponden a la <strong>base del ahorro del IRPF 2025</strong> (declaraci√≥n que se presenta entre abril y junio de 2026). Los tipos incluyen la parte estatal y auton√≥mica general. Tu comunidad aut√≥noma puede aplicar variaciones. √öltima actualizaci√≥n: febrero 2026.
    </div>

    <!-- Mode switch -->
    <div class="switch-mode">
      <button class="active" data-mode="simple">Modo simple</button>
      <button data-mode="advanced">Varias operaciones</button>
    </div>

    <!-- Simple mode -->
    <div id="simple-mode">
      <div class="tax-section">
        <div class="input-group">
          <label class="input-label">Ganancia total por venta de crypto (‚Ç¨)</label>
          <div class="input-wrapper">
            <span class="currency">‚Ç¨</span>
            <input type="number" id="simple-gain" placeholder="10.000" min="0" step="100">
          </div>
          <p style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px;">Precio de venta menos precio de compra. Si has hecho varias operaciones, suma todas las ganancias.</p>
        </div>
        <div class="input-group">
          <label class="input-label">P√©rdidas a compensar (‚Ç¨, opcional)</label>
          <div class="input-wrapper">
            <span class="currency">‚Ç¨</span>
            <input type="number" id="simple-losses" placeholder="0" min="0" step="100">
          </div>
          <p style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px;">P√©rdidas de otras ventas de crypto o activos del mismo a√±o.</p>
        </div>
        <div id="simple-error" class="error-msg"></div>
        <button class="calc-btn" id="calc-simple">Calcular impuestos</button>
      </div>
    </div>

    <!-- Advanced mode -->
    <div id="advanced-mode" style="display:none;">
      <div class="tax-section">
        <h3>Operaciones de venta</h3>
        <p style="font-size:0.8125rem;color:var(--text-secondary);margin-bottom:12px;">Introduce el coste total de compra y el importe total de venta de cada operaci√≥n.</p>
        <div id="operations-list" class="operations-list"></div>
        <button class="add-btn" id="add-op">+ A√±adir operaci√≥n</button>
        <button class="calc-btn" id="calc-advanced">Calcular impuestos</button>
      </div>
    </div>

    <!-- Results -->
    <div id="tax-results" style="display:none;">
      <div id="tax-summary"></div>
      <div id="tax-breakdown"></div>
      <div id="tax-tramos-applied"></div>
      <button class="share-btn" id="share-tax" style="margin-top:16px;">Compartir en X</button>
    </div>

    <!-- Info section -->
    <section style="margin-top:48px;">
      <h2 class="faq-title" style="font-size:1.125rem;margin-bottom:16px;">¬øC√≥mo tributan las criptomonedas en Espa√±a?</h2>

      <div class="legal-notice" style="margin-bottom:16px;">
        <p style="margin-bottom:8px;"><strong>Tramos base del ahorro IRPF 2025</strong> (vigentes desde 1 enero 2025, Ley 7/2024):</p>
        <table class="tramos-table">
          <tr><th>Base imponible</th><th>Tipo</th></tr>
          <tr><td>Hasta 6.000 ‚Ç¨</td><td>19%</td></tr>
          <tr><td>6.000 ‚Ç¨ ‚Äî 50.000 ‚Ç¨</td><td>21%</td></tr>
          <tr><td>50.000 ‚Ç¨ ‚Äî 200.000 ‚Ç¨</td><td>23%</td></tr>
          <tr><td>200.000 ‚Ç¨ ‚Äî 300.000 ‚Ç¨</td><td>27%</td></tr>
          <tr><td>M√°s de 300.000 ‚Ç¨</td><td>30%</td></tr>
        </table>
        <p style="font-size:0.75rem;">Novedad 2025: el tramo superior pasa del 28% al 30% para ganancias que excedan 300.000‚Ç¨.</p>
      </div>
    </section>

    <!-- FAQ -->
    <section class="faq" style="margin-top:32px;">
      <h2 class="faq-title">Preguntas frecuentes</h2>

      <details class="faq-item">
        <summary>¬øCu√°ndo tengo que declarar mis criptomonedas?</summary>
        <p>Debes declarar en la renta (Modelo 100) cualquier ganancia o p√©rdida patrimonial obtenida por transmisiones de criptomonedas, sin m√≠nimo exento. La campa√±a de la Renta 2025 se presenta entre abril y junio de 2026. Adem√°s, si tienes m√°s de 50.000‚Ç¨ en crypto en exchanges extranjeros a 31 de diciembre, debes presentar el Modelo 721 antes del 31 de marzo.</p>
      </details>

      <details class="faq-item">
        <summary>¬øQu√© operaciones tributan?</summary>
        <p>Vender crypto por euros, intercambiar una crypto por otra (ej: BTC ‚Üí ETH), usar crypto como pago y donar criptomonedas. La mera compra o el hold no generan obligaci√≥n fiscal. Transferir entre tus propias wallets tampoco tributa.</p>
      </details>

      <details class="faq-item">
        <summary>¬øC√≥mo funciona el m√©todo FIFO?</summary>
        <p>FIFO (First In, First Out) significa que cuando vendes, el coste de adquisici√≥n se basa en la primera compra que hiciste. Ejemplo: compraste 1 BTC a 10.000‚Ç¨ en enero y otro a 15.000‚Ç¨ en junio. Si vendes 1 BTC, el coste base es 10.000‚Ç¨, no 15.000‚Ç¨. El m√©todo se aplica de forma global, no por exchange.</p>
      </details>

      <details class="faq-item">
        <summary>¬øEl staking y los airdrops tributan diferente?</summary>
        <p>S√≠. Las recompensas de staking tributan como rendimiento del capital mobiliario en la base del ahorro (mismos tramos, 19-30%). Los airdrops, seg√∫n la AEAT, se consideran ganancias patrimoniales no derivadas de transmisi√≥n y van a la base general (con tipos del 19% al 47%). Cuando vendes los tokens recibidos por staking o airdrop, se produce una segunda tributaci√≥n por la plusval√≠a o minusval√≠a.</p>
      </details>

      <details class="faq-item">
        <summary>¬øPuedo compensar las p√©rdidas?</summary>
        <p>S√≠. Las p√©rdidas se compensan primero con las ganancias patrimoniales del mismo a√±o (incluyendo acciones, fondos, etc.). Si quedan p√©rdidas pendientes, puedes compensar hasta un 25% de los rendimientos del capital mobiliario. Las p√©rdidas no compensadas se arrastran durante 4 ejercicios.</p>
      </details>

      <details class="faq-item">
        <summary>¬øQu√© modelos fiscales afectan a las crypto?</summary>
        <p><strong>Modelo 100 (IRPF):</strong> declarar ganancias/p√©rdidas. <strong>Modelo 721:</strong> informativo, si tienes +50.000‚Ç¨ en exchanges extranjeros a 31/12. <strong>Modelo 714 (Patrimonio):</strong> si tu patrimonio neto supera ~700.000‚Ç¨. Los Modelos 172 y 173 los presentan los exchanges, no el contribuyente.</p>
      </details>

      <details class="faq-item">
        <summary>¬øQu√© pasa si no declaro?</summary>
        <p>Hacienda puede imponer multas de hasta el 150% de la cuota defraudada. Desde 2026, los exchanges y custodios est√°n obligados a informar autom√°ticamente a la AEAT. Adem√°s, Hacienda cruza datos con exchanges europeos gracias a la directiva DAC8.</p>
      </details>
    </section>

    <p class="disclaimer" style="margin-top:32px;">* Calculadora orientativa basada en la normativa vigente a fecha de febrero 2026. Los tramos corresponden a la base del ahorro del IRPF 2025 (Ley 7/2024). No incluye particularidades auton√≥micas. Consulta con un asesor fiscal para tu situaci√≥n particular. Esto no es asesoramiento fiscal.</p>

    <section class="cta-section" aria-label="Hardware wallets recomendados">
      <p class="cta-label">Protege tus bitcoin con una hardware wallet</p>
      <div class="cta-row">
        <a href="https://trezor.io/?ref=bitcoincalculadora" target="_blank" rel="noopener sponsored" class="cta-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="5" y="11" width="14" height="10" rx="2"/>
            <path d="M12 3a4 4 0 0 0-4 4v4h8V7a4 4 0 0 0-4-4z"/>
          </svg>
          Trezor
        </a>
        <a href="https://shop.ledger.com/?r=ab735c3bd51c" target="_blank" rel="noopener sponsored" class="cta-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="5" y="11" width="14" height="10" rx="2"/>
            <path d="M12 3a4 4 0 0 0-4 4v4h8V7a4 4 0 0 0-4-4z"/>
          </svg>
          Ledger
        </a>
        <a href="https://bitbox.swiss/bitbox02/nova/?ref=kwktktar" target="_blank" rel="noopener sponsored" class="cta-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="5" y="11" width="14" height="10" rx="2"/>
            <path d="M12 3a4 4 0 0 0-4 4v4h8V7a4 4 0 0 0-4-4z"/>
          </svg>
          BitBox
        </a>
      </div>
      <div class="cta-row">
        <a href="https://store.blockstream.com/collections/physical-storage" target="_blank" rel="noopener sponsored" class="cta-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="5" y="11" width="14" height="10" rx="2"/>
            <path d="M12 3a4 4 0 0 0-4 4v4h8V7a4 4 0 0 0-4-4z"/>
          </svg>
          Blockstream
        </a>
      </div>
    </section>

    <div class="price-info">
      <div class="price-live">
        <span class="price-dot loading" id="price-dot" aria-hidden="true"></span>
        <span>1 BTC = <span id="btc-price">cargando...</span></span>
      </div>
      <span class="api-source" id="api-source"></span>
    </div>

    <footer>
      <p>
        Calculadora gratuita ¬∑ No almacenamos ning√∫n dato<br>
        Precios en tiempo real ¬∑ <a href="#" id="refresh-price">Actualizar precio</a><br><br>
        ¬© 2026 <a href="/">Bitcoin Calculadora</a> ¬∑ Esto no es asesoramiento financiero
      </p>
    </footer>


  </main>

  <script src="/js/main.js"></script>

<script>
    // =====================================================
    // CALCULADORA DE IMPUESTOS CRYPTO - ESPA√ëA 2025/2026
    // =====================================================
    // Marco legal vigente:
    // - Ganancias patrimoniales por transmisi√≥n de crypto
    //   tributan en la BASE DEL AHORRO del IRPF
    // - M√©todo de c√°lculo: FIFO (First In, First Out)
    //   Art. 33-37 Ley IRPF
    // - Tramos actualizados desde 1 enero 2025
    //   (Ley 7/2024, BOE 21/12/2024)
    // - Compensaci√≥n de p√©rdidas: Art. 49 Ley IRPF
    //
    // NOTA: Esta herramienta es orientativa.
    // No sustituye asesoramiento fiscal profesional.
    // =====================================================

    // Tramos base del ahorro IRPF 2025 (vigentes para declaraci√≥n 2026)
    // Fuente: Agencia Tributaria + Ley 7/2024
    const TRAMOS_AHORRO_2025 = [
      { hasta: 6000,   tipo: 0.19 },   // 19% primeros 6.000‚Ç¨
      { hasta: 50000,  tipo: 0.21 },   // 21% de 6.000 a 50.000‚Ç¨
      { hasta: 200000, tipo: 0.23 },   // 23% de 50.000 a 200.000‚Ç¨
      { hasta: 300000, tipo: 0.27 },   // 27% de 200.000 a 300.000‚Ç¨
      { hasta: Infinity, tipo: 0.30 }  // 30% a partir de 300.000‚Ç¨
    ];

    let mode = 'simple';
    let operations = [];
    let opCounter = 0;

    // --- Mode switch ---
    document.querySelectorAll('.switch-mode button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.switch-mode button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        mode = btn.dataset.mode;
        document.getElementById('simple-mode').style.display = mode === 'simple' ? 'block' : 'none';
        document.getElementById('advanced-mode').style.display = mode === 'advanced' ? 'block' : 'none';
      });
    });

    // --- Simple mode ---
    document.getElementById('calc-simple').addEventListener('click', () => {
      const gain = parseFloat(document.getElementById('simple-gain').value);
      const losses = parseFloat(document.getElementById('simple-losses').value) || 0;
      if (isNaN(gain)) {
        document.getElementById('simple-error').textContent = 'Introduce una ganancia v√°lida.';
        document.getElementById('simple-error').style.display = 'block';
        return;
      }
      document.getElementById('simple-error').style.display = 'none';
      const netGain = gain - Math.abs(losses);
      displayResults(netGain, Math.abs(losses));
    });

    // --- Advanced mode: multiple operations ---
    function addOperation() {
      opCounter++;
      const div = document.createElement('div');
      div.className = 'operation-row';
      div.id = `op-${opCounter}`;
      div.innerHTML = `
        <div>
          <label class="input-label">Precio compra (‚Ç¨)</label>
          <div class="input-wrapper" style="margin-bottom:0">
            <input type="number" class="op-buy" placeholder="10.000" min="0" step="100">
          </div>
        </div>
        <div>
          <label class="input-label">Precio venta (‚Ç¨)</label>
          <div class="input-wrapper" style="margin-bottom:0">
            <input type="number" class="op-sell" placeholder="25.000" min="0" step="100">
          </div>
        </div>
        <button class="remove-op" onclick="this.parentElement.remove()">‚úï Eliminar</button>
      `;
      document.getElementById('operations-list').appendChild(div);
    }

    document.getElementById('add-op').addEventListener('click', addOperation);

    document.getElementById('calc-advanced').addEventListener('click', () => {
      const rows = document.querySelectorAll('.operation-row');
      let totalGain = 0;
      let totalLoss = 0;
      rows.forEach(row => {
        const buy = parseFloat(row.querySelector('.op-buy').value) || 0;
        const sell = parseFloat(row.querySelector('.op-sell').value) || 0;
        const diff = sell - buy;
        if (diff > 0) totalGain += diff;
        else totalLoss += Math.abs(diff);
      });
      const netGain = totalGain - totalLoss;
      displayResults(netGain, totalLoss);
    });

    // --- Tax calculation engine ---
    function calculateTax(baseImponible) {
      if (baseImponible <= 0) return { total: 0, breakdown: [], effectiveRate: 0 };

      let remaining = baseImponible;
      let totalTax = 0;
      let prevLimit = 0;
      const breakdown = [];

      for (const tramo of TRAMOS_AHORRO_2025) {
        const tramoSize = tramo.hasta - prevLimit;
        const taxable = Math.min(remaining, tramoSize);
        if (taxable <= 0) break;
        const taxAmount = taxable * tramo.tipo;
        totalTax += taxAmount;
        breakdown.push({
          desde: prevLimit,
          hasta: Math.min(tramo.hasta, prevLimit + taxable),
          tipo: tramo.tipo,
          base: taxable,
          cuota: taxAmount
        });
        remaining -= taxable;
        prevLimit = tramo.hasta;
      }

      return {
        total: totalTax,
        breakdown: breakdown,
        effectiveRate: (totalTax / baseImponible) * 100
      };
    }

    function displayResults(netGain, losses) {
      const resultsDiv = document.getElementById('tax-results');

      if (netGain <= 0) {
        document.getElementById('tax-summary').innerHTML = `
          <p style="font-size:1.125rem;font-weight:500;">No tienes que pagar impuestos</p>
          <p class="loss-info">Tienes p√©rdidas netas de <strong class="negative">${formatEur(Math.abs(netGain))}</strong>.</p>
          <div class="info-box">
            <strong>üí° Compensaci√≥n de p√©rdidas:</strong> Puedes compensar estas p√©rdidas con ganancias patrimoniales de los pr√≥ximos <strong>4 a√±os</strong>. Tambi√©n puedes compensar hasta un <strong>25%</strong> con rendimientos del capital mobiliario (intereses, dividendos). Art. 49 Ley IRPF.
          </div>
        `;
        document.getElementById('tax-breakdown').innerHTML = '';
        document.getElementById('tax-tramos-applied').innerHTML = '';
        resultsDiv.style.display = 'block';
        return;
      }

      const result = calculateTax(netGain);

      // Summary
      let summaryHtml = `
        <div class="results" style="margin-bottom:16px;">
          <div class="result-row">
            <span class="result-label">Ganancia neta</span>
            <span class="result-value positive">${formatEur(netGain)}</span>
          </div>
          ${losses > 0 ? `<div class="result-row">
            <span class="result-label">P√©rdidas compensadas</span>
            <span class="result-value negative">-${formatEur(losses)}</span>
          </div>` : ''}
          <div class="result-row">
            <span class="result-label">Impuestos a pagar</span>
            <span class="result-value total-tax">${formatEur(result.total)}</span>
          </div>
          <div class="result-row">
            <span class="result-label">Tipo efectivo</span>
            <span class="result-value">${result.effectiveRate.toFixed(1)}%</span>
          </div>
          <div class="result-row">
            <span class="result-label">Te quedas con</span>
            <span class="result-value positive">${formatEur(netGain - result.total)}</span>
          </div>
        </div>
      `;
      document.getElementById('tax-summary').innerHTML = summaryHtml;

      // Breakdown by tramos
      let breakdownHtml = '<h4 style="font-size:0.9375rem;font-weight:500;margin:16px 0 8px;">Desglose por tramos</h4>';
      result.breakdown.forEach(t => {
        breakdownHtml += `
          <div class="breakdown-item">
            <span>${formatEur(t.desde)} ‚Äî ${t.hasta === Infinity ? '‚àû' : formatEur(t.hasta)} (${(t.tipo*100)}%)</span>
            <span>${formatEur(t.cuota)}</span>
          </div>
        `;
      });
      document.getElementById('tax-breakdown').innerHTML = breakdownHtml;

      // Tramos table with highlighting
      let tramosHtml = '<h4 style="font-size:0.9375rem;font-weight:500;margin:16px 0 8px;">Tramos base del ahorro IRPF 2025</h4>';
      tramosHtml += '<table class="tramos-table"><tr><th>Base imponible</th><th>Tipo</th></tr>';
      const tramosDisplay = [
        { label: 'Hasta 6.000 ‚Ç¨', tipo: '19%', limit: 6000 },
        { label: '6.000 ‚Ç¨ ‚Äî 50.000 ‚Ç¨', tipo: '21%', limit: 50000 },
        { label: '50.000 ‚Ç¨ ‚Äî 200.000 ‚Ç¨', tipo: '23%', limit: 200000 },
        { label: '200.000 ‚Ç¨ ‚Äî 300.000 ‚Ç¨', tipo: '27%', limit: 300000 },
        { label: 'M√°s de 300.000 ‚Ç¨', tipo: '30%', limit: Infinity }
      ];
      tramosDisplay.forEach(t => {
        const isActive = netGain > (t.limit === 6000 ? 0 : TRAMOS_AHORRO_2025[tramosDisplay.indexOf(t) - 1]?.hasta || 0);
        tramosHtml += `<tr class="${isActive && netGain > 0 ? 'highlight-row' : ''}"><td>${t.label}</td><td>${t.tipo}</td></tr>`;
      });
      tramosHtml += '</table>';
      document.getElementById('tax-tramos-applied').innerHTML = tramosHtml;

      resultsDiv.style.display = 'block';

      // Share
      document.getElementById('share-tax').onclick = () => {
        const text = `Mis ganancias crypto: ${formatEur(netGain)}\nImpuestos: ${formatEur(result.total)} (tipo efectivo ${result.effectiveRate.toFixed(1)}%)\n\nCalcula los tuyos:`;
        shareOnTwitter(text, 'https://bitcoincalculadora.com/calculadora-impuestos/');
      };
    }

    // Add initial operation in advanced mode
    addOperation();
    initPriceUpdates();
  </script>

</body>
</html>